name: Generate Ayna Playlist

on:
  schedule:
    # Runs every 6 hours (adjust as needed)
    - cron: '0/30 * * * *'
  workflow_dispatch: # Allows you to run this manually from the Actions tab

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Essential for committing the new file

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate ayna.m3u
        run: |
          python -c '
          import requests
          import json

          # The URL of the JSON file
          url = "https://raw.githubusercontent.com/devmujahidul/Auto_Fetch/refs/heads/main/output.json"

          try:
              print(f"Fetching JSON from {url}...")
              response = requests.get(url)
              response.raise_for_status()
              data = response.json()

              print("Generating M3U playlist...")
              with open("ayna.m3u", "w", encoding="utf-8") as f:
                  f.write("#EXTM3U\n\n")
                  
                  # Loop through channels in the JSON
                  for channel in data.get("channels", []):
                      c_id = channel.get("id", "")
                      c_name = channel.get("title", "Unknown Channel")
                      # Use "image" first, fallback to "logo", or empty string
                      c_logo = channel.get("image") or channel.get("logo") or ""
                      c_url = channel.get("url", "")

                      # Only add if a URL exists
                      if c_url:
                          # Write the EXTINF line
                          f.write(f"#EXTINF:-1 tvg-id=\"{c_id}\" tvg-name=\"{c_name}\" tvg-logo=\"{c_logo}\",{c_name}\n")
                          # Write the URL line
                          f.write(f"{c_url}\n\n")
              
              print("ayna.m3u created successfully.")

          except Exception as e:
              print(f"Error occurred: {e}")
              exit(1)
          '

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ayna.m3u
          # Check if there are any changes to commit
          if git diff --staged --quiet; then
            echo "No changes detected. Skipping commit."
          else
            git commit -m "Auto-update ayna.m3u playlist"
            git push
          fi
